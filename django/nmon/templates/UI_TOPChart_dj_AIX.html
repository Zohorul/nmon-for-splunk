{% extends "UI_TOPChart_body.html" %}

{% load splunkmvc %}
{% load nmon %}


{% block css %}
{{block.super}}
<style type="text/css">

#d3chart-top30cpu{
   height: 572px;
}

#d3chart-top30memory{
   height: 572px;
}

#d3chart-top30swap{
   height: 572px;
}

</style>
{% endblock css %}


    {% block heading %}

	<div class="customimgheader">
	
	<img src="{{STATIC_URL}}/nmon/logos/NMON_simplelogo.png" alt="Nmon"/>	
	<h1>NMON TOP CPU and Memory Statistics</h1>

	</div>        
    
    {% endblock heading %}
    
    
   
    {% block usage%}

      <p>Change your parameters if required:</p>
		<p> </p>

		
        <table class="table table-striped table-bordered">


            <tr>
                <td>
				
				<p></p>
                <h2>TimeRange:</h2>
                </td>
                <td>
					<p></p>
    				{% timerange id="timerange" 
					managerid="search1" 
        			preset="Last 24 hours"
        			earliest_time="$earlyval$"|token_safe
        			latest_time="$lateval$"|token_safe %}                
					<p></p>                
                </td>
            </tr>

            <tr>
                <td>
					 <p></p>
                <h2>Time Filtering:</h2>
                </td>
                <td>
                	<p></p>
						{% dropdown id="filtertime-dropdown" width="200" default="No_Filter" value="$valuesfiltertime$"|token_safe %}
						<p></p>                
                </td>
            </tr>		

            <tr>
                <td>
					<p></p>
					<h2>Optional Filters</h2>
				</td>
					<td>

                <p></p>                
                <h2>Filter OS Type:</h2>
                <p></p>                
                {% radiogroup id="osfilter-radiogroup" default="| search [ `nmon_inventory` | search OStype=AIX | stats count by hostname | fields hostname ]" value="$valuesosfilter$"|token_safe%}
					
					<h2>Hosts Filtering:</h2>					

					<p></p>
					<p>Multiple patterns can be used including wildwards and logical operators,ex: SP* OR SQ*</p>					
					
					{% textinput id="hosts-textinput" value="$valueshosts$"|token_safe default="*" %}	

					<h2>PSeries Filtering - AIX Serial Number: (can be pre-filtered by Hosts filter)</h2>					

					<p></p>
					<p>Enter or Select AIX Serial Numbers, in PSeries environment the S/N of AIX hosts is the PSeries S/N</p>					
					
					{% dropdown id="sn-dropdown" managerid="sn-populate" valueField="AIX_Machine_SerialNumber" default="*" value="$valuesserialnum$"|token_safe %}						

				</td>
            </tr>			
	
            <tr>
                <td>
					<p></p>
					<h2>Select a CPU usage Monitor:</h2>
				</td>
					<td>
					
					<p></p>

					<h2>Monitors Information:</h2>

					<li>CPU_ALL: CPU Usage in Percentage</li>
					<li>LPAR: Micro Partition Usage in VPs</li>
					<li>LPAR: Default Pool Usage in VPs (keeping 1 partition per PSeries)</li>

					<p></p>

					{% dropdown id="monitor-dropdown" width="250" default="LPAR | eval usage=round(((VP_User_PCT+VP_Sys_PCT+VP_Wait_PCT+VP_Idle_PCT)*virtualCPUs/100),2) | eval pct_usage=round((VP_User_PCT+VP_Sys_PCT+VP_Wait_PCT+VP_Idle_PCT),2)" value="$valuesmonitor$"|token_safe %}	

				</td>
            </tr>			
			
            <tr>
                <td>
					<p></p>
					<h2>Select a Stats Mode:</h2>
                </td>
                <td>
					<p></p>
					{% dropdown id="stats-dropdown" width="250" default="avg" value="$valuesstats$"|token_safe %}	
				</td>
            </tr>

        </table>
		
    {% endblock usage%}


    {% block cpu-searchcontrol %}	
	
	{% searchcontrols 
		id="searchcontrol-cpu" 
		managerid="search-cpu" %}
	
    {% endblock cpu-searchcontrol %}	
	
	
    {% block d3chart-cpu %}
				
		{% d3chart 
            id="d3chart-top30cpu" 
            managerid="search-cpu-top30"
			type="pieChart" %}
		
    {% endblock d3chart-cpu %}		

    {% block table-cpu %}

		{% table 
		id="table-cpu" 
		managerid="search-table-cpu"
		pageSize="20" %}
			
    {% endblock table-cpu %}



    {% block memory-searchcontrol %}	
	
	{% searchcontrols 
		id="searchcontrol-memory" 
		managerid="search-memory" %}
	
    {% endblock memory-searchcontrol %}	
	
	
	
    {% block d3chart-memory %}
				
		{% d3chart 
            id="d3chart-top30memory" 
            managerid="search-memory-top30"
			type="pieChart" %}
		
    {% endblock d3chart-memory %}		

    {% block table-memory %}

		{% table 
		id="table-memory" 
		managerid="search-table-memory"
		pageSize="20" %}
			
    {% endblock table-memory %}	
	
	
	
    {% block swap-searchcontrol %}	
	
	{% searchcontrols 
		id="searchcontrol-swap" 
		managerid="search-swap" %}
	
    {% endblock swap-searchcontrol %}	
	
	
	
    {% block d3chart-swap %}
				
		{% d3chart 
            id="d3chart-top30swap" 
            managerid="search-swap-top30"
				type="pieChart" %}
		
    {% endblock d3chart-swap %}		

    {% block table-swap %}

		{% table 
		id="table-swap" 
		managerid="search-table-swap"
		pageSize="20" %}
			
    {% endblock table-swap %}	
	
	
{% block managers %}

<!-- Populate -->

	<!-- Populate dropdown (main search) -->
	
	{% searchmanager
		id="sn-populate" search='| inputlookup nmon_inventory | search hostname=$valueshosts$ | stats count by AIX_Machine_SerialNumber | sort AIX_Machine_SerialNumber'|token_safe
		earliest_time="$earlyval$"|token_safe
		latest_time="$lateval$"|token_safe
		cache=True
		auto_cancel=60
		preview=True %}

<!-- CPU Usage -->
    	
	{% searchmanager 
	id="search-cpu" 
	search='index=nmon hostname=$valueshosts$ serialnum=*$valuesserialnum$* $valuesmonitor$ $valuesosfilter$ | `$valuesfiltertime$` | stats $valuesstats$(usage) As usage, $valuesstats$(pct_usage) As pct_usage, max(entitled) As entitled, max(virtualCPUs) As virtualCPUs by hostname | fields hostname,usage,pct_usage,*'|token_safe 
	earliest_time="$earlyval$"|token_safe
	latest_time="$lateval$"|token_safe
	cache=False
	auto_cancel=60
	preview=True %}
	
	{% postprocessmanager 
	id="search-cpu-top30" 
	managerid="search-cpu" 
	search="| sort - pct_usage | fields hostname,usage | head 30" %}
	
	{% postprocessmanager 
	id="search-table-cpu" 
	managerid="search-cpu" 
	search="| sort - pct_usage | eval usage=round(usage,2) | eval pct_usage=round(pct_usage,2)" %}
	
<!-- MEMORY Usage -->
    
	{% searchmanager 
	id="search-memory" 
	search='index="nmon" sourcetype="nmon_data" hostname=$valueshosts$ serialnum=*$valuesserialnum$* type="MEM" $valuesosfilter$ | `$valuesfiltertime$` | `MEM_eval` | stats $valuesstats$(Real_free_MB) As Real_free_MB, $valuesstats$(Real_used_MB) As Real_used_MB, $valuesstats$(Real_total_MB) As Real_total_MB, $valuesstats$(Real_used_PCT) As Real_used_PCT by hostname'|token_safe 
	earliest_time="$earlyval$"|token_safe
	latest_time="$lateval$"|token_safe
	cache=False
	auto_cancel=60
	preview=True %}
	
	{% postprocessmanager 
	id="search-memory-top30" 
	managerid="search-memory" 
	search=" | fields hostname,Real_used_PCT | eval Real_used_PCT=round(Real_used_PCT,2) | sort - Real_used_PCT | head 30" %}
	
	{% postprocessmanager 
	id="search-table-memory" 
	managerid="search-memory" 
	search="| fields hostname,Real_used_PCT, Real_used_MB, Real_total_MB | eval Real_used_PCT=round(Real_used_PCT,2) | eval Real_used_MB=round(Real_used_MB,0) | eval Real_total_MB=round(Real_total_MB,0)" %}

<!-- SWAP Usage -->
    
	{% searchmanager 
	id="search-swap" 
	search='index="nmon" sourcetype="nmon_data" hostname=$valueshosts$ serialnum=*$valuesserialnum$* type="MEM" $valuesosfilter$ | `$valuesfiltertime$` | `MEM_eval` | stats $valuesstats$(Virtual_free_MB) As Virtual_free_MB, $valuesstats$(Virtual_used_MB) As Virtual_used_MB, $valuesstats$(Virtual_total_MB) As Virtual_total_MB, $valuesstats$(Virtual_used_PCT) As Virtual_used_PCT by hostname'|token_safe
	earliest_time="$earlyval$"|token_safe
	latest_time="$lateval$"|token_safe
	cache=False
	auto_cancel=60
	preview=True %}
	
	{% postprocessmanager 
	id="search-swap-top30" 
	managerid="search-swap" 
	search=" | fields hostname,Virtual_used_PCT | eval Virtual_used_PCT=round(Virtual_used_PCT,2) | sort - Virtual_used_PCT | where Virtual_used_PCT>0 | head 30" %}
	
	{% postprocessmanager 
	id="search-table-swap" 
	managerid="search-swap" 
	search="| fields hostname,Virtual_used_PCT, Virtual_used_MB, Virtual_total_MB | eval Virtual_used_PCT=round(Virtual_used_PCT,2) | eval Virtual_used_MB=round(Virtual_used_MB,0) | eval Virtual_total_MB=round(Virtual_total_MB,0) | sort - Virtual_used_PCT | where Virtual_total_MB>=0" %}
	
	
{% endblock managers %}

{% block js %}
{{ block.super }}
<script>
    require([
        "splunkjs/ready!", 
        "splunkjs/mvc/utils",
        "underscore",
        "jquery",
        "splunkjs/mvc/dropdownview"
        ], 
        function(
            mvc, 
            utils,
            _, 
            $,
            DropdownView
        		){

        var chart = mvc.Components.getInstance('d3chart-top30cpu');
			chart.settings.set("setup", function(chart){
			chart.showLabels(true);
            chart.showLegend(false);
			chart.donut(true);
				});					
				
        var chart = mvc.Components.getInstance('d3chart-top30memory');
			chart.settings.set("setup", function(chart){
			chart.showLabels(true);
            chart.showLegend(false);
			chart.donut(true);
				});					

        var chart = mvc.Components.getInstance('d3chart-top30swap');
			chart.settings.set("setup", function(chart){
			chart.showLabels(true);
            chart.showLegend(false);
			chart.donut(true);
				});
				
		var choices = [
        {label: " CPU_ALL - CPU Usage in %", value: "CPU_ALL | eval usage=(Sys_PCT+User_PCT+Wait_PCT) | eval pct_usage=(Sys_PCT+User_PCT+Wait_PCT)"},
        {label: " LPAR - MicroPartition CPU Usage in VCPUs", value: "LPAR | eval usage=round(((VP_User_PCT+VP_Sys_PCT+VP_Wait_PCT+VP_Idle_PCT)*virtualCPUs/100),2) | eval pct_usage=round((VP_User_PCT+VP_Sys_PCT+VP_Wait_PCT+VP_Idle_PCT),2)"},
        {label: " LPAR - Pools CPU Usage in VCPUs", value: "LPAR PoolIdle>0 | eval usage=round((poolCPUs-PoolIdle),2) | where usage>0 AND usage<poolCPUs | eval pct_usage=round(((poolCPUs-PoolIdle)*poolCPUs/100),2)"},
        ]  
 
		// Assign them to the button group
		splunkjs.mvc.Components.getInstance("monitor-dropdown").settings.set("choices", choices);
		
		var choices = [
        {label: " Max", value: "max"},
        {label: " Average", value: "avg"},
        ] 
 
		// Assign them to the button group
		splunkjs.mvc.Components.getInstance("stats-dropdown").settings.set("choices", choices);
		
		var choices = [
        {label: " AIX", value: "| search [ `nmon_inventory` | search OStype=AIX | stats count by hostname | fields hostname ]"},
        {label: " Inactive", value: ""}                
        ] 
 
		// Assign them to the button group
		splunkjs.mvc.Components.getInstance("osfilter-radiogroup").settings.set("choices", choices);	
		
		var choices = [
        {label: " No Filter", value: "No_Filter"},
        {label: " Day BusinessDays 8h-19h", value: "Day_BusinessDays_8h-19h"},
        {label: " Day WeekEnd 8h-19h", value: "Day_WeekEnd_8h-19h"},
        {label: " Day AllDays 8h-19h", value: "Day_AllDays_8h-19h"},        
        {label: " Night BusinessDays 19h-8h", value: "Night_BusinessDays_19h-8h"},
        {label: " Night WeekEnd 19h-8h", value: "Night_WeekEnd_19h-8h"},
        {label: " Night AllDays 19h-8h", value: "Night_AllDays_19h-8h"}
        ] 
 
		// Assign them to the button group
		splunkjs.mvc.Components.getInstance("filtertime-dropdown").settings.set("choices", choices);

		
    });
</script>

{% endblock js %}
